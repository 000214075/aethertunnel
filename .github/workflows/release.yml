name: Release AetherTunnel

on:
  push:
    branches: [ main ]
  tags:
    - 'v*'
  workflow_dispatch:

jobs:
  build:
    name: Build ${{ matrix.os }} ${{ matrix.arch }}
    runs-on: ubuntu-latest
    
    strategy:
      fail-fast: false
      matrix:
        os:
          - linux
          - windows
          - darwin
          - freebsd
        arch:
          - amd64
          - arm64
          - 386
          - arm
          - ppc64le
          - s390x
          - mips64
          - mips64le
        exclude:
          - os: windows
            arch: 386
          - os: windows
            arch: arm
          - os: windows
            arch: ppc64le
          - os: windows
            arch: s390x
          - os: windows
            arch: mips64
          - os: windows
            arch: mips64le
          - os: darwin
            arch: 386
          - os: darwin
            arch: arm
          - os: darwin
            arch: ppc64le
          - os: darwin
            arch: s390x
          - os: darwin
            arch: mips64
          - os: darwin
            arch: mips64le
          - os: freebsd
            arch: 386
          - os: freebsd
            arch: arm
          - os: freebsd
            arch: ppc64le
          - os: freebsd
            arch: s390x
          - os: freebsd
            arch: mips64
          - os: freebsd
            arch: mips64le

    steps:
      - uses: actions/checkout@v3

      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.21'

      - name: Download dependencies
        run: go mod download || true

      - name: Build Server
        env:
          GOOS: ${{ matrix.os }}
          GOARCH: ${{ matrix.arch }}
          GOARM: '7'
          CGO_ENABLED: '0'
        run: |
          if [ "${{ matrix.os }}" = "windows" ]; then
            go build -o dist/aethertunnel-server-${{ matrix.os }}-${{ matrix.arch }}.exe ./server
          else
            go build -o dist/aethertunnel-server-${{ matrix.os }}-${{ matrix.arch }} ./server
          fi

      - name: Build Client
        env:
          GOOS: ${{ matrix.os }}
          GOARCH: ${{ matrix.arch }}
          GOARM: '7'
          CGO_ENABLED: '0'
        run: |
          if [ "${{ matrix.os }}" = "windows" ]; then
            go build -o dist/aethertunnel-client-${{ matrix.os }}-${{ matrix.arch }}.exe ./client
          else
            go build -o dist/aethertunnel-client-${{ matrix.os }}-${{ matrix.arch }} ./client
          fi

      - name: Compress artifacts
        run: |
          cd dist
          for f in *; do
            gzip -9 -c "$f" > "$f.gz"
            xz -9 -c "$f" > "$f.xz"
          done

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.os }}-${{ matrix.arch }}
          path: dist/*

  create-release:
    name: Create Release
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    
    steps:
      - uses: actions/checkout@v3

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.ref }}
          name: ${{ github.ref }}
          draft: false
          prerelease: false
          generate_release_notes: true
          files: |
            *.gz
            *.xz
          body: |
            ## AetherTunnel ${{ github.ref }} Release
            
            ### Downloads
            
            Please select the binary for your platform.
            
            ### Installation
            
            1. Download the binary for your platform
            2. Extract the archive
            3. Run: `./aethertunnel-server -c server.toml.example`
            4. Run: `./aethertunnel-client -c client.toml.example`
            
            ### Documentation
            
            - [README](https://github.com/000214075/aethertunnel/blob/main/README.md)
            - [Quick Start](https://github.com/000214075/aethertunnel/blob/main/QUICK_START.md)
            - [Usage Guide](https://github.com/000214075/aethertunnel/blob/main/docs/USAGE.md)
            
            ### Changelog
            
            See [CHANGELOG.md](https://github.com/000214075/aethertunnel/blob/main/CHANGELOG.md) for details.
