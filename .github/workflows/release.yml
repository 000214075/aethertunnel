name: Release AetherTunnel

on:
  push:
    tags:
      - 'v*'
  release:
    types: [published]

env:
  GO_VERSION: '1.21'
  NAME: 'aethertunnel'

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Download dependencies
        run: go mod download || true

      - name: Build All Binaries
        run: |
          # Create dist directory
          mkdir -p dist

          # Build function
          build() {
            local os=$1
            local arch=$2
            local binary=$3
            local ext=$4
            
            echo "Building ${binary} for ${os}/${arch}..."
            
            GOOS=${os} GOARCH=${arch} CGO_ENABLED=0 \
              go build -ldflags="-s -w" \
              -o "dist/${binary}${ext}" \
              ${binary}.go || true
          }

          # Server binaries
          build linux amd64 aethertunnel-server ""
          build linux arm64 aethertunnel-server ""
          build linux armv7 aethertunnel-server ""
          build linux 386 aethertunnel-server ""
          build linux ppc64le aethertunnel-server ""
          build linux s390x aethertunnel-server ""
          build linux mips64 aethertunnel-server ""
          build linux mips64le aethertunnel-server ""
          build windows amd64 aethertunnel-server ".exe"
          build windows arm64 aethertunnel-server ".exe"
          build darwin amd64 aethertunnel-server ""
          build darwin arm64 aethertunnel-server ""
          build freebsd amd64 aethertunnel-server ""
          build freebsd arm64 aethertunnel-server ""

          # Client binaries
          build linux amd64 aethertunnel-client ""
          build linux arm64 aethertunnel-client ""
          build linux armv7 aethertunnel-client ""
          build linux 386 aethertunnel-client ""
          build linux ppc64le aethertunnel-client ""
          build linux s390x aethertunnel-client ""
          build linux mips64 aethertunnel-client ""
          build linux mips64le aethertunnel-client ""
          build windows amd64 aethertunnel-client ".exe"
          build windows arm64 aethertunnel-client ".exe"
          build darwin amd64 aethertunnel-client ""
          build darwin arm64 aethertunnel-client ""
          build freebsd amd64 aethertunnel-client ""
          build freebsd arm64 aethertunnel-client ""

          # List built files
          ls -lh dist/

      - name: Compress All Files
        run: |
          cd dist
          for f in *; do
            if [ -f "$f" ]; then
              gzip -9 -c "$f" > "$f.gz" 2>/dev/null || true
              xz -9 -c "$f" > "$f.xz" 2>/dev/null || true
            fi
          done

      - name: Upload Release Assets
        uses: softprops/action-gh-release@v1
        with:
          files: |
            dist/*
          draft: false
          prerelease: false
          generate_release_notes: true
          body: |
            ## ğŸ‰ AetherTunnel ${{ github.ref_name }} Release

            ### ğŸ“¦ ä¸‹è½½æ–‡ä»¶

            è¯·æ ¹æ®ä½ çš„ç³»ç»Ÿé€‰æ‹©å¯¹åº”çš„äºŒè¿›åˆ¶æ–‡ä»¶ï¼š

            #### æœåŠ¡ç«¯
            - Linux AMD64: aethertunnel-server-linux-amd64
            - Linux ARM64: aethertunnel-server-linux-arm64
            - Windows AMD64: aethertunnel-server-windows-amd64.exe
            - macOS AMD64: aethertunnel-server-darwin-amd64

            #### å®¢æˆ·ç«¯
            - Linux AMD64: aethertunnel-client-linux-amd64
            - Linux ARM64: aethertunnel-client-linux-arm64
            - Windows AMD64: aethertunnel-client-windows-amd64.exe
            - macOS AMD64: aethertunnel-client-darwin-amd64

            ### ğŸ”’ å®‰å…¨

            - æ‰€æœ‰æ–‡ä»¶éƒ½å·²åŒ…å«åœ¨ Release ä¸­
            - å»ºè®®ä¸‹è½½åéªŒè¯æ–‡ä»¶å®Œæ•´æ€§

            ### ğŸ“ ç‰ˆæœ¬ä¿¡æ¯

            - ç‰ˆæœ¬ï¼š${{ github.ref_name }}
            - æ„å»ºæ—¶é—´ï¼š${{ github.event.head_commit.timestamp }}
            - Git æäº¤ï¼š\`${{ github.sha }}\`

            ### ğŸš€ å¿«é€Ÿå¼€å§‹

            1. ä¸‹è½½å¯¹åº”å¹³å°çš„äºŒè¿›åˆ¶æ–‡ä»¶
            2. è§£å‹æˆ–è§£å‹å¹¶æ·»åŠ æ‰§è¡Œæƒé™
            3. å¤åˆ¶é…ç½®æ–‡ä»¶ç¤ºä¾‹ï¼š\`cp server.toml.example server.toml\`
            4. è¿è¡Œï¼š\`./aethertunnel-server -c server.toml\`
