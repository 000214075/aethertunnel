# AetherTunnel 架构设计文档

## 目录

1. [概述](#概述)
2. [架构原则](#架构原则)
3. [系统架构](#系统架构)
4. [核心组件](#核心组件)
5. [通信流程](#通信流程)
6. [数据流](#数据流)
7. [扩展机制](#扩展机制)

## 概述

AetherTunnel 是一个基于 Go 语言实现的高性能、安全增强型内网穿透工具。它采用了模块化的设计理念，将各个功能组件解耦，提供了良好的可扩展性和可维护性。

### 设计目标

- **安全性优先**：多层认证和加密机制
- **高性能**：连接复用和智能连接池
- **可扩展性**：插件系统和模块化设计
- **跨平台**：支持主流操作系统和CPU架构
- **易用性**：简洁的配置和清晰的使用文档

## 架构原则

### 1. 分层架构

```
┌─────────────────────────────────────────┐
│         Application Layer              │  ← 应用层（代理、监控）
├─────────────────────────────────────────┤
│         Service Layer                  │  ← 服务层（控制、连接管理）
├─────────────────────────────────────────┤
│         Protocol Layer                 │  ← 协议层（消息编解码）
├─────────────────────────────────────────┤
│         Transport Layer                │  ← 传输层（TLS、多路复用）
├─────────────────────────────────────────┤
│         Network Layer                  │  ← 网络层（TCP、UDP）
└─────────────────────────────────────────┘
```

### 2. 关注点分离

- **控制面**：管理连接、认证、配置
- **数据面**：处理实际的数据转发
- **管理面**：监控、日志、API

### 3. 零信任原则

每个连接、每条消息都需要验证，不信任默认网络环境。

## 系统架构

### 整体架构图

```
┌─────────────────────────────────────────────────────────────┐
│                        AetherTunnel Server                   │
├─────────────────────────────────────────────────────────────┤
│  ┌───────────┐  ┌───────────┐  ┌───────────┐  ┌──────────┐ │
│  │  HTTP/HTTPS│  │   TCP    │  │   UDP    │  │ Dashboard│ │
│  │   Proxy   │  │  Proxy   │  │  Proxy   │  │  Server  │ │
│  └───────────┘  └───────────┘  └───────────┘  └──────────┘ │
│         │              │              │              │      │
│  ┌─────────────────────────────────────────────────────┐   │
│  │              Proxy Manager                          │   │
│  └─────────────────────────────────────────────────────┘   │
│         │                                                   │
│  ┌─────────────────────────────────────────────────────┐   │
│  │              Control Manager                         │   │
│  └─────────────────────────────────────────────────────┘   │
│         │                                                   │
│  ┌─────────────────────────────────────────────────────┐   │
│  │    Auth | Audit | Session | Connection Limiters    │   │
│  └─────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
                            ↕
                    TLS 1.3 + Multiplexing
                            ↕
┌─────────────────────────────────────────────────────────────┐
│                        AetherTunnel Client                   │
├─────────────────────────────────────────────────────────────┤
│  ┌───────────┐  ┌───────────┐  ┌───────────┐             │
│  │  HTTP/HTTPS│  │   TCP    │  │   UDP    │             │
│  │   Proxy   │  │  Proxy   │  │  Proxy   │             │
│  └───────────┘  └───────────┘  └───────────┘             │
│         │              │              │                    │
│  ┌─────────────────────────────────────────────────────┐   │
│  │              Control Connection                      │   │
│  └─────────────────────────────────────────────────────┘   │
│         │                                                   │
│  ┌─────────────────────────────────────────────────────┐   │
│  │           Auth Manager | Proxy Manager                │   │
│  └─────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
         │              │              │
         ↓              ↓              ↓
    ┌─────────┐  ┌─────────┐  ┌─────────┐
    │   Web   │  │   SSH   │  │  Other  │
    │ Service │  │ Service │  │ Service │
    └─────────┘  └─────────┘  └─────────┘
```

## 核心组件

### 服务端组件

#### 1. Server (server/main.go)

主服务器，负责：
- 启动和管理所有子组件
- 处理信号和优雅关闭
- 管理TLS配置和监听器
- 启动HTTP仪表板

#### 2. ControlManager (server/control.go)

控制连接管理器，负责：
- 管理所有客户端控制连接
- 处理客户端登录和认证
- 维护会话状态
- 心跳检测和超时处理

#### 3. ProxyManager (server/proxy.go)

代理管理器，负责：
- 创建和销毁代理实例
- 管理监听端口
- 分发工作连接
- 收集代理状态

#### 4. Auth & Security (pkg/util/auth.go)

认证和安全模块，提供：
- Token 认证
- Ed25519 签名验证
- 连接限制
- IP 封禁
- 审计日志

### 客户端组件

#### 1. Client (client/main.go)

主客户端，负责：
- 建立与服务器的连接
- 管理密钥对
- 注册代理
- 维护控制连接

#### 2. Control (client/main.go)

控制连接，负责：
- 与服务器保持连接
- 发送心跳
- 处理服务器指令
- 接收工作连接请求

### 公共组件

#### 1. Protocol (pkg/protocol/)

消息协议定义：
- Login/LoginResp：登录认证
- NewProxy/NewProxyResp：代理注册
- StartWorkConn：工作连接建立
- Ping/Pong：心跳保活
- 数据结构定义和序列化

#### 2. Crypto (pkg/crypto/)

加密模块：
- **AEAD (aead.go)**：ChaCha20-Poly1305 加密
- **Signature (signature.go)**：Ed25519 签名和 HMAC
- 密钥派生和管理

#### 3. Network (pkg/net/)

网络工具：
- **Mux (mux.go)**：yamux 多路复用封装
- TLS 配置和连接
- Context 连接封装
- 连接和数据转发

#### 4. Config (pkg/config/)

配置管理：
- TOML 配置解析
- 配置验证
- 默认值设置

## 通信流程

### 1. 客户端登录流程

```
Client                          Server
  │                               │
  │  1. TCP/TLS Connect          │
  ├─────────────────────────────▶ │
  │                               │
  │  2. Login (Token + Signature) │
  ├─────────────────────────────▶ │
  │                               │  ┌─────────────┐
  │                               │  │ Verify Token│
  │                               │  └─────────────┘
  │                               │
  │  3. LoginResp (runID + Nonce) │
  │ ◀─────────────────────────────┤
  │                               │
  │  4. Register Proxies          │
  ├─────────────────────────────▶ │
  │                               │
  │  5. Proxy Responses           │
  │ ◀─────────────────────────────┤
  │                               │
  │  6. Start Heartbeat           │
  │ ◀─────────── Ping ───────────▶ │
  │ ◀─── Pong ───────────────────▶ │
  │                               │
```

### 2. 数据转发流程

```
External User              Server                Client                Local Service
     │                        │                     │                        │
     │  1. Connect             │                     │                        │
     ├──────────────────────▶│                     │                        │
     │                        │                     │                        │
     │                        │  2. Get Work Conn   │                        │
     │                        ├────────────────────▶│                        │
     │                        │                     │                        │
     │                        │  3. StartWorkConn  │                        │
     │                        │◀────────────────────┤                        │
     │                        │                     │  4. Connect Local     │
     │                        │                     ├───────────────────────▶│
     │                        │                     │                        │
     │  5. Data Forward       │                     │                        │
     │ ◀─────────────────────▶│                     │                        │
     │                        │  6. Data Forward    │                        │
     │                        ├────────────────────▶│                        │
     │                        │                     │  7. Data Forward      │
     │                        │                     ├───────────────────────▶│
     │                        │                     │                        │
     │                        │                     │  8. Response Data     │
     │                        │◀────────────────────┤◀──────────────────────┤
     │  9. Response Data       │                     │                        │
     │ ◀─────────────────────▶│                     │                        │
```

## 数据流

### 1. 控制通道数据流

```
┌──────────┐    Message    ┌──────────┐    Message    ┌──────────┐
│  Client  │ ────────────▶ │  Server  │ ◀──────────── │  Client  │
└──────────┘               └──────────┘               └──────────┘
   Login                         NewProxyResp
   NewProxy                       Ping
   Ping                           StartWorkConn
   CloseProxy
```

### 2. 数据通道数据流

```
┌───────────┐    User Data    ┌───────────┐    Work Data   ┌───────────┐
│  External │ ──────────────▶ │  Server   │ ────────────▶ │  Client   │
│   User    │                │           │               │           │
└───────────┘                └───────────┘               └───────────┘
                                                                 │
                                                                ▼
                                                         ┌───────────┐
                                                         │   Local   │
                                                         │  Service  │
                                                         └───────────┘
```

## 扩展机制

### 1. 代理类型扩展

通过实现 `Proxy` 接口可以添加新的代理类型：

```go
type Proxy interface {
    Run() error
    HandleWorkConn(conn net.Conn, msg *StartWorkConn)
    Close()
}
```

### 2. 认证方式扩展

通过实现 `AuthVerifier` 接口可以添加新的认证方式：

```go
type AuthVerifier interface {
    VerifyLogin(login *Login) error
    VerifyWorkConn(msg *NewWorkConn) error
}
```

### 3. 加密方式扩展

通过实现 `Cipher` 接口可以添加新的加密算法：

```go
type Cipher interface {
    Encrypt(plaintext []byte) ([]byte, error)
    Decrypt(ciphertext []byte) ([]byte, error)
}
```

### 4. 插件系统（计划中）

未来将支持插件系统，允许：
- 自定义消息处理
- 集成第三方认证
- 添加监控和分析功能
- 实现自定义路由策略

## 性能优化

### 1. 连接复用

使用 yamux 实现多路复用，在单个 TCP 连接上承载多个逻辑连接：
- 减少 TCP 连接建立开销
- 降低网络延迟
- 节省服务器资源

### 2. 连接池

维护工作连接池，快速响应用户连接：
- 预先建立连接
- 动态调整池大小
- 连接复用和回收

### 3. 批量消息处理

优化消息处理逻辑，减少上下文切换

## 安全设计

### 1. 多层认证

```
TLS 层（双向证书验证）
    ↓
Token 层（共享密钥验证）
    ↓
Signature 层（Ed25519 签名验证）
    ↓
IP 白名单（可选）
```

### 2. 端到端加密

- TLS 1.3 传输加密
- ChaCha20-Poly1305 数据加密（可选）
- 每个连接独立的密钥派生

### 3. 审计和监控

- 记录所有认证事件
- 记录代理创建和删除
- 记录连接建立和断开
- 支持实时监控

## 总结

AetherTunnel 的架构设计遵循以下原则：

1. **模块化**：各个组件职责清晰，便于维护和扩展
2. **安全性**：多层防护，零信任原则
3. **性能**：连接复用和智能池管理
4. **易用性**：简洁的配置和清晰的API

通过这种架构设计，AetherTunnel 既保证了安全性，又提供了良好的性能和可扩展性。
